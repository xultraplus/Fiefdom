# 《采邑春秋》地形系统设计

## 系统概述

《采邑春秋》的地形系统包括：
1. **世界地图**：探索区域
2. **封地地图**：玩家经营的封地
3. **地形类型**：平原、山地、森林、水域等
4. **地块系统**：TileMap网格化
5. **季节变化**：视觉效果和游戏影响

---

## 1. 世界地图

### 1.1 区域划分

世界分为7个大区域：

| 区域名称 | 地理位置 | 特色 | 解锁条件 |
|---------|---------|------|----------|
| **封地** | 中心 | 玩家大本营 | 初始 |
| **荒野** | 北部 | 蛮族领地 | 探索解锁 |
| **山林** | 东部 | 狩猎场 | "射"≥Lv.3 |
| **矿山** | 西部 | 石材、铜矿 | "御"≥Lv.5 |
| **水域** | 南部 | 渔场 | 任意水域 |
| **城镇** | 东南部 | 交易中心 | 声望≥200 |
| **王都** | 远方 | 周天子驻地 | "卿"爵位 |

### 1.2 探索机制

#### 探索方式

| 方式 | 消耗 | 速度 | 解锁内容 |
|------|------|------|----------|
| 步行 | 体力10/格 | 慢 | 周围1格 |
| 骑马 | 体力5/格 | 快 | 周围2格 |
| 战车 | 体力3/格 | 极快 | 周围3格 |

#### 战争迷雾

- **未探索**：黑色，完全不可见
- **已探索未可见**：灰色，地形可见但动态不可见
- **可见区域**：彩色，实时可见

**可见范围**：
- 玩家周围：3格×3格
- 建筑瞭望塔：周围5格×5格
- 门客守卫：周围2格×2格

---

## 2. 封地地图

### 2.1 地图规模

**初始封地**：
- 尺寸：50×50格（2500格）
- 可用井田：1个（9格）
- 建筑用地：预留100格

**扩展封地**：
- 中士：70×70格（4900格）
- 上士：90×90格（8100格）
- 大夫：120×120格（14400格）
- 卿：150×150格（22500格）

### 2.2 地形分布

#### 平原 (Plains)

**占比**：约60%

**特征**：
- 地势平坦，适合耕种
- 可开垦为井田
- 移动速度：100%

**视觉**：
- 颜色：浅绿色
- 纹理：短草
- 装饰：零星小花

**用途**：
- 耕种
- 建筑
- 放牧

#### 山地 (Mountains)

**占比**：约15%

**特征**：
- 地势陡峭，不可耕种
- 不可通过（需绕行）
- 可开采矿产

**视觉**：
- 颜色：灰褐色
- 纹理：岩石
- 装饰：峭壁

**用途**：
- 采石
- 采铜
- 采矿（需科技）

#### 森林 (Forests)

**占比**：约15%

**特征**：
- 不可直接耕种
- 需要砍伐才能开垦
- 可采集木材、果实

**视觉**：
- 颜色：深绿色
- 纹理：树木
- 装饰：灌木

**用途**：
- 伐木（获得木材）
- 采集果实
- 狩猎

#### 水域 (Water)

**占比**：约10%

**类型**：
- 河流（带状，不可通过）
- 湖泊（块状，不可通过）
- 池塘（小块，可改造为水田）

**特征**：
- 不可耕种（除池塘改水田）
- 阻断移动
- 可钓鱼

**视觉**：
- 颜色：蓝色
- 纹理：水波纹
- 动画：流水效果

**用途**：
- 钓鱼
- 灌溉（附近农田产量+20%）
- 水田（种水稻）

#### 沼泽 (Swamps)

**占比**：约5%

**特征**：
- 移动速度-50%
- 不可耕种
- 可采集药材

**视觉**：
- 颜色：暗绿色
- 纹理：泥浆
- 装饰：枯木

**用途**：
- 采集药材
- 陷阱（战斗用）

### 2.3 TileMap系统

#### 分层设计

| 层级 | 名称 | 用途 | 透明度 |
|------|------|------|--------|
| Layer 0 | 地形层 | 地形基础（平原/山地/森林/水域） | 不透明 |
| Layer 1 | 作物层 | 种植的作物 | 半透明 |
| Layer 2 | 建筑层 | 房屋、设施 | 不透明 |
| Layer 3 | 单位层 | 玩家、门客、敌人 | 透明 |
| Layer 4 | 特效层 | 高亮、标记等 | 透明 |

#### Tile属性

每个Tile包含以下数据：

```gdscript
class_name TileData extends Resource

@export var terrain_type: TerrainType
@export var is_walkable: bool
@export var is_farmable: bool
@export var is_public_field: bool
@export var fertility: int           # 肥力：0-100
@export var moisture: int            # 湿度：0-100
@export var occupied_by: Variant     # 占用者（作物/建筑/单位）

enum TerrainType {
    PLAINS,       # 平原
    MOUNTAIN,     # 山地
    FOREST,       # 森林
    WATER,        # 水域
    SWAMP,        # 沼泽
    FARMLAND,     # 农田
    PADDY         # 水田
}
```

---

## 3. 地形互动

### 3.1 开垦系统

#### 开垦流程

**第1步：选择位置**
- 移动鼠标到目标3x3区域
- 绿色高亮=可开垦
- 红色高亮=不可开垦

**第2步：验证条件**
- 所有9格必须为平原或森林
- 不能有障碍物（建筑、单位）
- 井田之间至少间隔1格
- 爵位允许的井田数未满

**第3步：确认开垦**
- 检查资源（铜钱、粮食）
- 分配门客
- 开始开垦

**第4步：等待完成**
- 4天后井田可用
- 期间无法种植

#### 森林开垦额外步骤

如果目标区域是森林：

**第1步：伐木（1天）**
- 门客砍伐树木
- 获得木材×10

**第2-4步：同普通开垦**

### 3.2 季节变化

#### 春季（春分-谷雨）

**视觉变化**：
- 平原：浅绿色→嫩绿色
- 树木：发芽
- 水域：水位上涨

**游戏影响**：
- 播种季节：作物产量+20%
- 森林果实丰富
- 动物繁殖期

#### 夏季（立夏-大暑）

**视觉变化**：
- 平原：深绿色
- 树木：茂盛
- 水域：水位正常

**游戏影响**：
- 生长季节：作物生长+30%
- 浇水需求高
- 可能干旱（灾害）

#### 秋季（立秋-霜降）

**视觉变化**：
- 平原：黄绿色
- 树木：落叶
- 水域：水位下降

**游戏影响**：
- 收获季节：作物产量+10%
- 粮食价格下降20%
- 动物迁徙

#### 冬季（立冬-大寒）

**视觉变化**：
- 平原：枯黄色
- 树木：光秃
- 水域：结冰（北部）
- 降雪效果

**游戏影响**：
- 休耕季节：无法种植
- 粮食价格上涨30%
- 燃料消耗增加
- 可能暴雪（灾害）

---

## 4. 建筑系统

### 4.1 建筑类型

#### 住宅建筑

| 建筑 | 消耗 | 容量 | 效果 |
|------|------|------|------|
| 茅屋 | 木材×50 + 石材×20 | 2人 | 基础住宿 |
| 瓦房 | 木材×100 + 石材×50 + 瓦×20 | 4人 | 舒适住宿 |
| 庭院 | 木材×200 + 石材×100 + 瓦×50 | 8人 | 豪华住宿 |
| 城堡 | 木材×500 + 石材×300 + 青铜×100 | 16人 | 极品住宿 |

**影响**：
- 住宿等级过低：门客忠诚度-2/天
- 住宿等级过高：门客忠诚度+1/天

#### 生产建筑

| 建筑 | 消耗 | 功能 | 推荐学派 |
|------|------|------|----------|
| 工坊 | 木材×100 | 制作工具 | 墨家 |
| 织布机 | 木材×50 + 丝绸×10 | 织绸 | 墨家 |
| 酒坊 | 木材×80 + 粮食×50 | 酿酒 | 任意 |
| 铁匠铺 | 木材×100 + 石材×50 + 铁矿石×20 | 打造武器 | 兵家 |
| 畜棚 | 木材×150 + 石材×50 | 饲养家畜 | 农家 |

#### 防御建筑

| 建筑 | 消耗 | 功能 | 耐久 |
|------|------|------|------|
| 篱笆 | 木材×20 | 阻挡小型野兽 | 50 |
| 木墙 | 木材×50 | 阻挡中型野兽 | 100 |
| 石墙 | 石材×100 | 阻挡所有敌人 | 300 |
| 箭塔 | 木材×100 + 石材×50 | 自动攻击敌人 | 200 |
| 瞭望塔 | 木材×150 + 石材×80 | 扩大视野5格 | 250 |

#### 特殊建筑

| 建筑 | 消耗 | 功能 | 解锁条件 |
|------|------|------|----------|
| 祭坛 | 石材×100 + 青铜×50 | 举行祭祀 | "礼"≥Lv.3 |
| 学堂 | 木材×100 + 竹简×20 | 门客研习六艺 | "书"≥Lv.5 |
| 编钟室 | 青铜×200 | 演奏礼乐 | "乐"≥Lv.5 |
| 藏书阁 | 木材×200 + 竹简×50 | 储存典籍 | "书"≥Lv.8 |
| 观星台 | 石材×300 | 预测天气 | "数"≥Lv.10 |

### 4.2 建筑放置

#### 放置规则

1. **地形限制**：
   - 大部分建筑：平原
   - 水车：水域旁
   - 瞭望塔：高地

2. **空间要求**：
   - 小建筑：1×1格
   - 中建筑：2×2格
   - 大建筑：3×3格

3. **间距要求**：
   - 建筑之间至少间隔1格
   - 防御建筑可紧贴

4. **朝向系统**：
   - 建筑4个方向可选
   - 影响视觉效果（门的位置）

#### 建造流程

**第1步：选择建筑**
- 打开建造菜单
- 选择建筑类型

**第2步：选择位置**
- 鼠标移动到目标位置
- 绿色=可建造，红色=不可建造

**第3步：检查资源**
- 材料、铜钱是否足够

**第4步：开始建造**
- 分配门客建造
- 等待完成（建筑大小×1天）

**第5步：建造完成**
- 建筑投入使用
- 视觉效果更新

---

## 5. 地形事件

### 5.1 随机事件

| 事件 | 触发条件 | 效果 |
|------|----------|------|
| 降雨 | 随机（夏季多） | 作物生长+1天，无需浇水 |
| 干旱 | 随机（夏季） | 浇水需求×2，作物可能枯死 |
| 洪水 | 暴雨后 | 水域附近农田被淹 |
| 蝗灾 | 随机（秋季） | 大量作物被吃 |
| 暴雪 | 随机（冬季） | 无法出门，粮食消耗×2 |
| 泥石流 | 山地附近暴雨 | 山脚建筑损坏 |
| 山火 | 森林干旱 | 森林烧毁，变成平原 |
| 地震 | 随机 | 建筑损坏 |

### 5.2 季节事件

| 季节 | 事件 | 频率 | 奖励 |
|------|------|------|------|
| 春 | 春社祭祀 | 每年1次 | 声望+50，作物产量+20% |
| 夏 | 端午龙舟 | 每年1次 | 全体门客忠诚度+10 |
| 秋 | 秋社祭祀 | 每年1次 | 声望+50，粮食产量+20% |
| 冬 | 腊八祭祖 | 每年1次 | 声望+30，解锁新年事件 |

---

## 6. 地形美学

### 6.1 颜色方案

#### 调色板

| 地形 | 主色 | 辅色 | 高光 | 阴影 |
|------|------|------|------|------|
| 平原 | #7CBA5F | #5A9A3E | #9AD47F | #4A802E |
| 山地 | #8B7355 | #6B5345 | #AB9375 | #5B4335 |
| 森林 | #2D5A27 | #1D4A17 | #4D7A47 | #1D3A17 |
| 水域 | #4A90E2 | #3A70D2 | #6AB0F2 | #2A50B2 |
| 沼泽 | #3B5A37 | #2B3A27 | #5B7A57 | #1B2A17 |

### 6.2 动画效果

#### 水面动画
- 波浪移动（平移+缩放）
- 反光效果（闪烁）
- 流动方向（河流）

#### 植物动画
- 微风摇摆（旋转）
- 雨天弯曲（缩放）
- 季节变化（颜色渐变）

#### 天气效果
- 雨天：雨滴粒子
- 雪天：雪花飘落
- 雾天：遮罩层
- 晴天：阳光透射

---

## 7. 性能优化

### 7.1 视锥剔除

- 仅渲染可见区域（玩家周围10格×10格）
- 远处地形使用低LOD
- 动态加载/卸载区块

### 7.2 批量渲染

- 相同地形Tile合并渲染
- 静态建筑合并Mesh
- 粒子系统使用GPU加速

### 7.3 内存优化

- Tile图集（Texture Atlas）
- 压缩纹理格式
- 动态卸载远处资源

---

**文档版本**：v1.0
**最后更新**：2026-01-28
**作者**：游戏设计团队
